
<section id="login_gary" class="login_gary">
    <div class="login_box">
        <div id="login_del" class="login_del"></div>
        <p class="login_box_title">會員登入</p>
        <form action="#">
            <p> 帳號：<input type="text" placeholder="請輸入帳號" id='user_id' name="user_id"></p>
            <p> 密碼：<input type="password" placeholder="請輸入密碼" id='user_psw' name="user_psw"> </p>
        </form>
        <button class="btn_cloud" id='login_btn'> 登入<span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span></button>
        <a id="registered" href="#">立即註冊</a> <a href="#">忘記密碼</a>
    </div>
</section>






<section id="registered_gary" class="registered_gary">
    <div class="registered_box">
            <div id="registered_del" class="registered_del"></div>
        <p class="login_box_title">會員註冊</p>
        <form action="#" id="myForm">
            <p> 
                帳號：
                <input type="text" v-model="id"  placeholder="帳號*" maxlength="10">
                <span class="msg">最大長度：10</span>
            </p>
            <p> 
                名字：
                <input type="text" v-model="name"  placeholder="名稱*" maxlength="10">
                <span class="msg">最大長度：10</span>
            </p>
            <p>
                密碼：
                <input type="password" v-model="psw"  placeholder="密碼*" maxlength="10"> 
                <span class="msg">最大長度：10</span>
                </p>
            <p> 
                確認密碼：
                <input type="password" v-model="pswConfirm" v-bind:class="{ 'is-invalid':pswError }" placeholder="確認密碼*"> 
                <span class="msg">{{pswConfirmErrMsg}}</span>
            </p>
            <p> 
                電子郵件：
                <input type="text" v-model="email" v-bind:class="{ 'is-invalid':emailError }" placeholder="zoo@email.com*">
                <span class="msg">{{emailErrMsg}}</span>
            </p>
            <p> 請選擇密碼提示問題： 
                <select v-model="qsn">
                <option value="" >--請選擇--</option>
                <option v-for="qsn in qsns">{{qsn.hint_no+"."+qsn.hint_question}}</option>
            </select>
            <span class="msg">（忘記密碼時使用）</span>
            </p>
            <p>請輸入答案：<input v-model="hint" type="text" name="hint" placeholder="密碼提示答案*"></p>
        </form>
        <button class="btn_cloud" id="register_finish" @click="submit">完成<span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span></button>
        <a href="#" id="backLogin">返回登入</a> 
    </div>
</section>





<section  class="forgetPsw_gary">
    <div class="forgetPsw_box">
        <div id="forgetPsw_del" class="forgetPsw_del"></div>
        <p class="forgetPsw_box_title">忘記密碼</p>
        <form action="#">
            <p> 帳號：<input type="text" placeholder="請輸入帳號"></p>
            <p> 密碼：<input type="text" placeholder="請輸入答案"> </p>
        </form>
        <button class="btn_cloud" id='login_btn'> 登入<span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span></button>
    </div>
</section>





<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.js"></script>
<script>
    var form = new Vue({
        data: {
            id:"aaa",

            name: 'aaa',

            psw: '09871',

            pswConfirm:'09871',
            pswError:false,

            email: '1@zoo.com',
            emailError: false,

            qsn:"",
            qsns:[],
            // [ { "hint_no": "1", "hint_question": "你喜歡的水果為何？" }, { "hint_no": "2", "hint_question": "你是什麼星座" }, { "hint_no": "3", "hint_question": "你多高" } ]
            hint:'qqq',


        },
        computed: {
            pswStrength() {
                let isText =  /^[0][9][0-9]{8}$/;
                if (!isText.test(this.phone) && this.phone.length > 0) {
                    this.phoneError = true;
                    return '請輸入09開頭的10位數字';
                }
                else {
                    this.phoneError = false;
                }
            },
            pswConfirmErrMsg() {
                if (this.pswConfirm != this.psw &&  this.pswConfirm.length>0) {
                    this.pswError = true;
                    return '與密碼不符';
                } 
                else {
                    this.pswError = false;

                }
            },
            emailErrMsg() {
                let isText = /^\w+@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z]+$/;
                if (!isText.test(this.email) && this.email.length > 0) {
                    this.emailError = true;
                    return '請輸入正確email格式';
                }
                else {
                    this.emailError = false;
                }
            },
           
        },
        mounted(){
            fetch('php/login/register.php').then(qsns => qsns.json()).then(qsns => {this.qsns = qsns;});
        },
        methods:{
            submit(e){
            //驗證資料是否都合法
                let err=0;
                for(i in this.$data){
                    if (this.$data[i] === "" || this.$data[i] === true){
                        err++;
                        alert("請輸入完整資料")
                    }
                }
                if(err == 0){
                    let data={
                        "id":this.id,
                        "psw":this.psw,
                        "name":this.name,
                        "email":this.email,
                        "ans":this.hint,
                        "hint_no":this.qsn.charAt(0),
                    }
                    data=JSON.stringify(data);
                // console.log(JSON.stringify(data));
                //{"id":"aaa","psw":"09871","name":"aaa","email":"1@zoo.com","ans":"qqq","hint_no":"1"}
            //送出
                let xhr = new XMLHttpRequest();
                    xhr.onload = function () {
                        if (xhr.status == 200) {//登入成功
                            //寫入session storage
                            let userData = JSON.parse(xhr.responseText);
                            for (i in userData) {
                                sessionStorage.setItem(i, userData[i]);
                            }
                            $id("show_user_name").innerText = "您好，" + userData.user_name;
                            $id("login_text").innerText = "登出";
                            $id("login_gary").style.display = "none";
                            //讓會員中心可以進入
                            document.getElementsByClassName('member_icon')[0].onclick = null;
                            cancelRegistered();
                            
                        } else {
                            alert(xhr.statusText);
                        }
                    }
                    xhr.open("post", "php/login/register.php", true);
                    xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
                    xhr.send(`data=${data}`);
                }
            }
        }
    });
    form.$mount("#registered_gary");
</script>







<script>
    function $id(id) {
        return document.getElementById(id);
    };
    var userData;

    //進網頁or刷新時，聯結php，去sessionStorage撈資料，判斷使用者是否已登入
    function getLoginInfo() {
        if (sessionStorage.user_id) {   //已登入
            $id("show_user_name").innerText = "您好，" + sessionStorage.user_name;
            $id("login_text").innerText = "登出";
        } else {
            $id("login_text").innerText = "登入/註冊";    //尚未登入
            document.getElementsByClassName('member_icon')[0].onclick = function () {
                alert("請登入會員");
                return false;
            }
        }
    }


    //跳出登入視窗功能 + 登出功能  
    function showLoginForm() {
        if ($id('login_text').innerText == '登入/註冊') {  //按下去，跳出視窗
            $id('login_gary').style.display = 'block'
        } else if ($id('login_text').innerText == '登出') {   //按下去，要登出
            //clear session storage
            let user_id = sessionStorage.user_id;
            let user_psw =  sessionStorage.user_psw;
            let xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status == 200) {
                    if (xhr.responseText.indexOf("sysError") != -1) {
                        alert("系統異常,請通知系統維護人員");
                    }else { 
                        // console.log(xhr.responseText)
                        let userData = JSON.parse(xhr.responseText)[0];
                        for (i in userData) {
                            sessionStorage.removeItem(i);
                        }
                    }
                } else {
                    alert(xhr.statusText);
                }
            }
            xhr.open("post", "php/login/login.php", true);
            xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
            xhr.send(`user_id=${user_id}&user_psw=${user_psw}`);

            //clear session
            logOut();
            

            $id('login_text').innerHTML = "登入/註冊";
            $id("show_user_name").innerHTML = "&nbsp;";
            $id("user_id").value = "";
            $id("user_psw").value = "";
            //如果是在會員中心頁面登出，要跳回首頁
            if (window.location.href == "http://localhost/G3/member.php" ) {
                window.location.href = "http://localhost/G3/home.html"
            }else if(window.location.href == "http://localhost/G3/checkOrder.html"){
                window.location.href = "http://localhost/G3/cart.php"
            }
            //未登入，無法進入會員中心
            document.getElementsByClassName('member_icon')[0].onclick = function () {
                alert("請登入會員");
                return false;
            }
        }
        return false;
    }
    //清session
    function logOut(){
        var xhr = new XMLHttpRequest();
        xhr.open("Get", "php/login/logout.php",true);
            xhr.send( null );
    }
    
    //登入功能
    function sendForm() {
        let user_id = $id('user_id').value;
        let user_psw = $id('user_psw').value;
        //如果沒打字，不給登入
        if (user_id == '' || user_psw == '') {
            alert('帳號及密碼不可為空');
            //如果都打字了，才去判斷
        } else {
            let xhr = new XMLHttpRequest();

            xhr.onload = function () {
                if (xhr.status == 200) {
                    if (xhr.responseText.indexOf("sysError") != -1) {
                        alert("系統異常,請通知系統維護人員");
                    } else if (xhr.responseText.indexOf("loginError") != -1) {
                        alert("帳密錯誤");
                    } else { //登入成功
                        //寫入session storage
                        let userData = JSON.parse(xhr.responseText)[0];
                        for (i in userData) {
                            sessionStorage.setItem(i, userData[i]);
                        }
                        $id("show_user_name").innerText = "您好，" + userData.user_name;
                        $id("login_text").innerText = "登出";
                        $id("login_gary").style.display = "none";
                        //讓會員中心可以進入
                        document.getElementsByClassName('member_icon')[0].onclick = null;
                    }
                } else {
                    alert(xhr.statusText);
                }
            }
            xhr.open("post", "php/login/login.php", true);
            xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
            xhr.send(`user_id=${user_id}&user_psw=${user_psw}`);
        }
    }

    //取消登入,清input+關閉視窗
    function cancelLogin() {
        $id("user_id").value = "";
        $id("user_psw").value = "";
        $id('login_gary').style.display = 'none'

    }
    //叉叉關閉視窗  清input+關閉視窗
    function cancelRegistered() {
        cancelLogin();
        clearRegisterInfo();
        $id('registered_gary').style.display = 'none';
    }


    // //清空註冊input
    function clearRegisterInfo(){
        let input=document.querySelectorAll("#myForm input")
        input.forEach((n,i)=>{
            n.value="";
        })
        
    }

    window.addEventListener('load', function () {
        //---------檢查使用者是否已登入, 並取回登入資訊
        getLoginInfo();

        // 登入/註冊 按鍵   /跳出登入視窗功能 + 登出功能  
        $id("login_text").onclick = showLoginForm;
        
        // 送出登入資料
        $id("login_btn").addEventListener("click",sendForm);
        
        //取消登入,清input+關閉視窗
        $id("login_del").onclick = cancelLogin;
       
        //打開註冊視窗
        $id("registered").onclick =  function(){  
            $id('login_gary').style.display = 'none';
            $id('registered_gary').style.display = 'block';   
        }
      
        //叉叉關閉視窗
        $id("registered_del").onclick = cancelRegistered;  
      
        //送出註冊資料
        // $id("register_finish").onclick = sendRegisteration;
    
        //返回登入  打開視窗
        $id("backLogin").onclick=function(){   
        $id('registered_gary').style.display = 'none';
        $id('login_gary').style.display = 'block';
        }
        
    })
</script>