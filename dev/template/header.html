<input type="checkbox" name="" id="menu_check">
<label for="menu_check" class="hb_cover"></label>

<header class="main_menu">

    <div class="header_top"></div>

    <div class="header">
        <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
            viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
            <defs>
                <path id="gentle-wave"
                    d="M-177,9l352,2.5v16.9c-30,0-58,12.4-88,12.4S29,29.6-1,29.6S-59,41-89,41s-58-11.4-88-11.4V9z" />
            </defs>
            <g class="parallax">
                <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(255,255,255,0.7)" />
                <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(255,255,255,0.5)" />
                <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(255,255,255,0.3)" />
                <use xlink:href="#gentle-wave" x="48" y="7" fill="rgba(255,255,255,0.1)" />
            </g>
        </svg>
    </div>





    <div class="hcontainer">

        <a href="home.html" class="logo_s"><img src="img/header/logo.png" alt="logo-sm.png loss"></a>
        <a href="home.html" class="head_title_s">
            <h1>怪奇動物園</h1>
        </a>

        <nav class="menu_nav">

            <div class="logo_box">
                <a href="home.html" class="logo"><img src="img/header/logo.png" alt="logo-sm.png loss"></a>
                <a href="home.html" class="head_title">
                    <h1>怪奇動物園</h1>
                </a>
            </div>

            <ul class="menu_list">
                <li>
                    <a href="modify.html" class="menu_icon"><img src="img/header/hicon_koala.png" alt=""></a>
                    <a href="modify.html" class="text">動物改造</a>
                </li>
                <li>
                    <a href="game.html" class="menu_icon"><img src="img/header/hicon_lion.png" alt=""></a>
                    <a href="game.html" class="text">生存遊戲</a>
                </li>
                <li>
                    <a href="frank.html" class="menu_icon"><img src="img/header/hicon_tiger.png" alt=""></a>
                    <a href="frank.html" class="text">怪奇排行</a>
                </li>
                <li>
                    <a href="shop.php" class="menu_icon"><img src="img/header/hicon_sloth.png" alt=""></a>
                    <a href="shop.php" class="text">動物商城</a>
                </li>
                <li>
                    <a href="resv.html" class="menu_icon"><img src="img/header/hicon_elephant.png" alt=""></a>
                    <a href="resv.html" class="text">預約導覽</a>
                </li>
            </ul>
            <!-- js開始 -->
            <ul class="member_box">
                <li class='text'>
                    <span id="show_user_name"></span>
                    <a href="#" id='login_text'></a>
                </li>
                <li>
                    <a href="member.html" class="member_icon"><img src="img/header/icon_member.png" alt=""></a>
                </li>
                <li>
                    <a href="cart.html" class="member_icon cart_icon">
                        <img src="img/header/icon_cart.png" alt="">
                        <p id='cart_num' class='cart_num'>1</p>
                    </a>

                </li>
            </ul>
            <!-- <img class="page_now" src="img/header/head_cloud_icon.png" alt=""> -->
        </nav>

        <label for="menu_check" class="hb">
            <div class="bar1"></div>
            <div class="bar2"></div>
            <div class="bar3"></div>
            <div class="bar4"></div>
        </label>
    </div>


</header>



<section id="login_gary" class="login_gary">
    <div class="login_box">
        <div id="login_del" class="login_del"></div>
        <p>會員登入</p>
        <form action="#">
            <p> <input type="text" placeholder="帳號" id='user_id' name="user_id"></p>
            <p> <input type="text" placeholder="密碼" id='user_psw' name="user_psw"> </p>
        </form>
        <button class="btn_cloud" id='login_btn'> 登入<span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span>
            <span class="btn_cloudeffect"></span></button>
        <a href="#">立即註冊</a> <a href="#">忘記密碼</a>
    </div>
</section>


<script>
    function $id(id) {
        return document.getElementById(id);
    };
    var userData;

    //進網頁or刷新時，聯結php，去sessionStorage撈資料，判斷使用者是否已登入
    function getLoginInfo() {
        if (sessionStorage.user_id) {   //已登入
            $id("show_user_name").innerText = "您好，" + sessionStorage.user_name;
            $id("login_text").innerText = "登出";
        } else {
            $id("login_text").innerText = "登入/註冊";    //尚未登入
            document.getElementsByClassName('member_icon')[0].onclick = function () {
                alert("請登入會員");
                return false;
            }
        }
    }


    //跳出登入視窗功能 + 登出功能  
    function showLoginForm() {
        if ($id('login_text').innerText == '登入/註冊') {  //按下去，跳出視窗
            $id('login_gary').style.display = 'block'
        } else if ($id('login_text').innerText == '登出') {   //按下去，要登出
            //clear session storage
            let user_id = sessionStorage.user_id;
            let user_psw =  sessionStorage.user_psw;
            let xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (xhr.status == 200) {
                    if (xhr.responseText.indexOf("sysError") != -1) {
                        alert("系統異常,請通知系統維護人員");
                    }else { 
                        let userData = JSON.parse(xhr.responseText)[0];
                        for (i in userData) {
                            sessionStorage.removeItem(i);
                        }
                    }
                } else {
                    alert(xhr.statusText);
                }
            }
            xhr.open("post", "php/login/login.php", true);
            xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
            xhr.send(`user_id=${user_id}&user_psw=${user_psw}`);


            $id('login_text').innerHTML = "登入/註冊";
            $id("show_user_name").innerHTML = "&nbsp;";
            $id("user_id").value = "";
            $id("user_psw").value = "";
            //如果是在會員中心頁面登出，要跳回首頁
            if (window.location.href == "http://localhost/G3/member.html") {
                window.location.href = "http://localhost/G3/home.html"
            }
            //未登入，無法進入會員中心
            document.getElementsByClassName('member_icon')[0].onclick = function () {
                alert("請登入會員");
                return false;
            }
        }
        return false;
    }

    //登入功能
    function sendForm() {
        let user_id = $id('user_id').value;
        let user_psw = $id('user_psw').value;
        //如果沒打字，不給登入
        if (user_id == '' || user_psw == '') {
            alert('帳號及密碼不可為空');
            //如果都打字了，才去判斷
        } else {
            let xhr = new XMLHttpRequest();

            xhr.onload = function () {
                if (xhr.status == 200) {
                    if (xhr.responseText.indexOf("sysError") != -1) {
                        alert("系統異常,請通知系統維護人員");
                    } else if (xhr.responseText.indexOf("loginError") != -1) {
                        alert("帳密錯誤");
                    } else { //登入成功
                        //寫入session storage
                        let userData = JSON.parse(xhr.responseText)[0];
                        for (i in userData) {
                            sessionStorage.setItem(i, userData[i]);
                        }
                        $id("show_user_name").innerText = "您好，" + userData.user_name;
                        $id("login_text").innerText = "登出";
                        $id("login_gary").style.display = "none";
                        //讓會員中心可以進入
                        document.getElementsByClassName('member_icon')[0].onclick = null;
                    }
                } else {
                    alert(xhr.statusText);
                }
            }
            xhr.open("post", "php/login/login.php", true);
            xhr.setRequestHeader("content-type", "application/x-www-form-urlencoded");
            xhr.send(`user_id=${user_id}&user_psw=${user_psw}`);
        }
    }


    function cancelLogin() {
        $id("user_id").value = "";
        $id("user_psw").value = "";
        $id('login_gary').style.display = 'none'

    }




    window.addEventListener('load', function () {
        //---------檢查使用者是否已登入, 並取回登入資訊
        getLoginInfo();

        //===設定spanLogin.onclick 事件處理程序是 showLoginForm
        $id("login_text").onclick = showLoginForm;
        //===設定btnLogin.onclick 事件處理程序是 sendForm
        $id("login_btn").onclick = sendForm;
        // //===設定btnLoginCancel.onclick 事件處理程序是 cancelLogin
        $id("login_del").onclick = cancelLogin;
    })
</script>